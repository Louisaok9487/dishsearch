<script>
    // Remove direct API keys from client-side
    // const SPOONACULAR_API_KEY = "YOUR_SPOONACULAR_API_KEY";
    // const PEXELS_API_KEY = "YOUR_PEXELS_API_KEY";

    // ... (rest of your existing code)

    /**
     * Searches for recipes based on the user's input and displays a list of choices.
     */
    async function searchRecipes() {
        const query = dishInput.value.trim();
        if (!query) {
            displayError('Please enter a dish name.');
            return;
        }

        hideRecipeResults();
        hideSearchResults();
        hideError();
        showLoadingSpinner();

        try {
            // Call Netlify Function for Spoonacular search
            const searchUrl = `/.netlify/functions/spoonacular-proxy?search-recipes=true&query=${encodeURIComponent(query)}&number=5`;
            const searchResponse = await fetchWithRetry(searchUrl);
            const searchData = await searchResponse.json();

            if (searchData.results && searchData.results.length > 0) {
                currentSearchResults = searchData.results;
                displaySearchResults(searchData.results);
            } else {
                displayError(`No recipes found for "${query}". Please try a different dish name.`);
            }
        } catch (error) {
            console.error('Error searching for recipes:', error);
            displayError('Failed to search for recipes. Please try again later.');
        } finally {
            hideLoadingSpinner();
        }
    }

    /**
     * Fetches and displays a random recipe.
     */
    async function getRandomRecipe() {
        hideRecipeResults();
        hideSearchResults();
        hideError();
        showLoadingSpinner();

        try {
            // Call Netlify Function for random recipe
            const randomUrl = `/.netlify/functions/spoonacular-proxy?random-recipe=true`;
            const randomResponse = await fetchWithRetry(randomUrl);
            const randomData = await randomResponse.json();

            if (randomData.recipes && randomData.recipes.length > 0) {
                await getRecipeDetails(randomData.recipes[0].id);
            } else {
                displayError('Could not fetch a random recipe. Please try again.');
            }
        } catch (error) {
            console.error('Error fetching random recipe:', error);
            displayError('Failed to fetch a random recipe. Please try again later.');
        } finally {
            hideLoadingSpinner();
        }
    }

    /**
     * Fetches and displays detailed information for a given recipe ID.
     */
    async function getRecipeDetails(recipeId) {
        showLoadingSpinner();
        hideError();
        hideRecipeResults();

        try {
            // Call Netlify Function for recipe details
            const detailsUrl = `/.netlify/functions/spoonacular-proxy?get-recipe-details=true&recipeId=${recipeId}&includeNutrition=true`;
            const detailsResponse = await fetchWithRetry(detailsUrl);
            const recipe = await detailsResponse.json();

            await displayRecipe(recipe);
        } catch (error) {
            console.error('Error fetching recipe details:', error);
            displayError('Failed to retrieve recipe details. Please try again later.');
        } finally {
            hideLoadingSpinner();
        }
    }

    /**
     * Displays the recipe information on the page, including Pexels fallback for image.
     */
    async function displayRecipe(recipe) {
        dishTitle.textContent = recipe.title;

        let finalDishImageUrl = recipe.image;
        if (!finalDishImageUrl || !isValidImageUrl(finalDishImageUrl)) {
            console.log('Spoonacular image missing or invalid, trying Pexels...');
            try {
                // Call Netlify Function for Pexels search
                const pexelsSearchUrl = `/.netlify/functions/pexels-proxy?query=${encodeURIComponent(recipe.title)}`;
                const pexelsResponse = await fetchWithRetry(pexelsSearchUrl);
                const pexelsData = await pexelsResponse.json();

                if (pexelsData.photos && pexelsData.photos.length > 0) {
                    finalDishImageUrl = pexelsData.photos[0].src.medium;
                    console.log('Found image from Pexels:', finalDishImageUrl);
                } else {
                    console.log('No relevant image found on Pexels.');
                    finalDishImageUrl = 'https://placehold.co/400x300/e0e0e0/555555?text=No+Image+Available';
                }
            } catch (pexelsError) {
                console.error('Error fetching image from Pexels:', pexelsError);
                finalDishImageUrl = 'https://placehold.co/400x300/e0e0e0/555555?text=Image+Load+Error';
            }
        }
        dishImage.src = finalDishImageUrl;
        dishImage.alt = recipe.title;
        dishImage.onerror = () => { dishImage.src = 'https://placehold.co/400x300/e0e0e0/555555?text=Image+Load+Failed'; };

        // ... (rest of displayRecipe function remains the same)
    }

    /**
     * Fetches and displays ingredient substitutes in a modal.
     */
    async function getIngredientSubstitutes(ingredientId, ingredientName) {
        modalTitle.textContent = `Substitutes for ${ingredientName}`;
        substituteContent.innerHTML = '<p class="text-center text-gray-500">Loading substitutes...</p>';
        substituteModal.style.display = 'flex';

        try {
            // Call Netlify Function for ingredient substitutes
            const substitutesUrl = `/.netlify/functions/spoonacular-proxy?ingredient-substitutes=true&ingredientId=${ingredientId}`;
            const substitutesResponse = await fetchWithRetry(substitutesUrl);
            const substitutesData = await substitutesResponse.json();

            if (substitutesData.substitutes && substitutesData.substitutes.length > 0) {
                substituteContent.innerHTML = `<ul class="list-disc pl-5 space-y-1">
                    ${substitutesData.substitutes.map(sub => `<li>${sub}</li>`).join('')}
                </ul>`;
            } else {
                substituteContent.innerHTML = `<p class="text-center text-gray-500">No common substitutes found for ${ingredientName}.</p>`;
            }
        } catch (error) {
            console.error('Error fetching substitutes:', error);
            substituteContent.innerHTML = '<p class="text-center text-red-500">Failed to load substitutes. Please try again.</p>';
        }
    }

    // ... (rest of helper functions and event listeners remain the same)
</script>
